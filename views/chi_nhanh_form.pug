extends layout

block content
  h1= title
  p Welcome to #{title}

  form#dailyForm
    label(for="date") Ch·ªçn ng√†y:
    input(type="date", name="date", id="date", required=true)
    p(style="margin-top: 10px; font-style: italic; color: #555;")
        | üìå Tr√† Lipton ƒë∆∞·ª£c t√≠nh theo ƒë∆°n v·ªã 
        strong g√≥i
        | , c√°c lo·∫°i tr√† c√≤n l·∫°i theo 
        strong gram
        | . Th√†nh ph·∫©m ƒë∆∞·ª£c t√≠nh theo 
        strong l√≠t
        | , tr√¢n ch√¢u th√¨ t√≠nh theo 
        strong ph·∫ßn
        | . Th·ªùi gian n·∫•u tr√† v√† tr√¢n ch√¢u 
        strong ca 1 kh√¥ng
        |  ƒë·ªÉ trong b√°o c√°o n√™n c√≥ th·ªÉ ƒë·ªÉ theo m·∫∑c ƒë·ªãnh.
    p(style="font-style: italic; color: #777; font-size: 13px; margin-top: 5px")
        | ‚õî Tr√¢n ch√¢u n·∫•u ·ªü 
        strong Ca 2
        |  v√† 
        strong Ca 3
        |  kh√¥ng c·∫ßn ƒëi·ªÅn th√†nh ph·∫©m, h·ªá th·ªëng s·∫Ω t·ª± b·ªè qua khi xu·∫•t b√°o c√°o.

    .shift-wrapper
      each ca in ['Ca 1', 'Ca 2', 'Ca 3']
        .shift-column(data-ca=ca)
          h3= ca
          .entry-container
          button(type="button", onclick="addRow(this)", class="add-row") ‚ûï Th√™m d√≤ng m·ªõi

    button(type="button", onclick="exportData()", style="margin-top: 20px") üì§ Xu·∫•t d·ªØ li·ªáu
    pre#exportResult(style="white-space: pre-wrap; margin-top: 15px; background: #f4f4f4; padding: 10px; border-radius: 5px")
    button(type="button", onclick="copyExportResult()", style="margin-top: 10px") üìã Copy k·∫øt qu·∫£

  script.
    const BRANCH = !{JSON.stringify(branch)};
    document.addEventListener('DOMContentLoaded', async function () {
      const dateInput = document.getElementById('date');
      const today = new Date().toLocaleDateString('en-CA');
      dateInput.value = today;
      dateInput.addEventListener('change', () => loadDataForDate(dateInput.value));
      await loadDataForDate(today);
    });

    function getCurrentTimeHHMM() {
      const now = new Date();
      return now.toTimeString().slice(0, 5);
    }

    const TRA_LIST = [
      's·ªë 1', 's·ªë 2', 's·ªë 3', 's·ªë 4', 's·ªë 5', 's·ªë 6',
      'crane', 'lipton', 'cafe', 'tr√¢n ch√¢u tr√†', 'tr√¢n ch√¢u ƒëen'
    ];

    function createTraSelect(selected) {
      const select = document.createElement('select');
      select.required = true;
      TRA_LIST.forEach(text => {
        const option = document.createElement('option');
        option.value = text;
        option.textContent = text;
        if (selected === text) option.selected = true;
        select.appendChild(option);
      });
      return select;
    }

    function addRow(button) {
      const container = button.previousElementSibling;
      const ca = button.parentNode.getAttribute('data-ca');
      const date = document.getElementById('date').value;

      const row = document.createElement('div');
      row.className = 'entry-row';

      const traSelect = createTraSelect();

      const soLuongInput = document.createElement('input');
      soLuongInput.type = 'number';
      soLuongInput.placeholder = 'S·ªë l∆∞·ª£ng';
      soLuongInput.min = 0;

      const thanhPhamInput = document.createElement('input');
      thanhPhamInput.placeholder = 'Th√†nh ph·∫©m';

      const timeInput = document.createElement('input');
      timeInput.type = 'time';
      timeInput.value = getCurrentTimeHHMM();

      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.textContent = '‚ûï';
      saveBtn.style.marginLeft = '5px';

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'üóë';
      deleteBtn.style.marginLeft = '5px';

      row.append(traSelect, soLuongInput, thanhPhamInput, timeInput, saveBtn, deleteBtn);
      container.appendChild(row);

      saveBtn.addEventListener('click', () => {
        const data = {
          ca, ngay: date,
          traSo: traSelect.value,
          soLuong: parseFloat(soLuongInput.value),
          thanhPham: thanhPhamInput.value,
          thoiGian: timeInput.value
        };
        if(data.ca == "Ca 1"){
          if (!data.traSo || !data.thanhPham || !data.thoiGian || isNaN(data.soLuong)) {
            alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
            return;
          }
        }else{
          if( data.traSo == "tr√¢n ch√¢u ƒëen" || data.traSo == "tr√¢n ch√¢u tr√†"){
            if (!data.traSo || !data.thoiGian || isNaN(data.soLuong)) {
              alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
              return;
            }
          } else{
            if (!data.traSo || !data.thanhPham || !data.thoiGian || isNaN(data.soLuong)) {
              alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
              return;
            }
          }
        }
        const ref = firebase.database().ref(`${BRANCH}`).push();
        ref.set(data).then(() => {
          row.setAttribute('data-id', ref.key);
          saveBtn.style.display = 'none';
        });
      });

      deleteBtn.addEventListener('click', () => {
        const id = row.getAttribute('data-id');
        if (id) firebase.database().ref(`${BRANCH}/` + id).remove();
        row.remove();
      });
    }

    async function loadDataForDate(date) {
      document.querySelectorAll('.entry-container').forEach(c => c.innerHTML = '');
      try {
        const snapshot = await firebase.database().ref(`${BRANCH}`)
          .orderByChild('ngay')
          .equalTo(date)
          .get();
        const data = snapshot.val();
        if (!data) return;

        Object.entries(data).forEach(([id, item]) => {
          const container = document.querySelector(`[data-ca="${item.ca}"] .entry-container`);
          if (!container) return;

          const row = document.createElement('div');
          row.className = 'entry-row';
          row.setAttribute('data-id', id);

          const traSelect = createTraSelect(item.traSo);

          const soLuongInput = document.createElement('input');
          soLuongInput.type = 'number';
          soLuongInput.value = item.soLuong;
          soLuongInput.step = "any"; // cho ph√©p nh·∫≠p s·ªë th·∫≠p ph√¢n

          const thanhPhamInput = document.createElement('input');
          thanhPhamInput.value = item.thanhPham;

          const timeInput = document.createElement('input');
          timeInput.type = 'time';
          timeInput.value = item.thoiGian || getCurrentTimeHHMM();

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.textContent = 'üóë';
          deleteBtn.style.marginLeft = '5px';

          deleteBtn.addEventListener('click', () => {
            firebase.database().ref(`${BRANCH}/` + id).remove();
            row.remove();
          });

          row.append(traSelect, soLuongInput, thanhPhamInput, timeInput, deleteBtn);
          container.appendChild(row);
        });
      } catch (err) {
        console.error("L·ªói khi load d·ªØ li·ªáu:", err);
      }
    }

    function exportData() {
      const date = document.getElementById('date').value;
      firebase.database().ref(`${BRANCH}`)
        .orderByChild('ngay')
        .equalTo(date)
        .get()
        .then(snapshot => {
          const data = snapshot.val();
          if (!data) {
            document.getElementById('exportResult').textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu cho ng√†y ƒë√£ ch·ªçn.';
            return;
          }

          const caData = { 'Ca 1': [], 'Ca 2': [], 'Ca 3': [] };
          Object.values(data).forEach(entry => {
            if (caData[entry.ca]) caData[entry.ca].push(entry);
          });

          let result = '1) S·ªê L∆Ø·ª¢NG N·∫§U TR√Ä\nCa 1:\n';
          const traList = TRA_LIST.slice(0, 9);
          const tcList = TRA_LIST.slice(9);

          // ‚úÖ Th√™m d√≤ng n√†y ƒë·ªÉ khai b√°o "records"
          const records = caData['Ca 1'].filter(e => traList.includes(e.traSo.toLowerCase()));

          if (records.length > 0) {
            records.forEach(r => {
              const unit = r.traSo.toLowerCase() === 'lipton' ? 'g√≥i' : 'gram';
              result += `‚Ä¢ Tr√† ${r.traSo} n·∫•u ${r.soLuong} ${unit} ‚Üí ${r.thanhPham} l√≠t (sau khi fill ra ca)\n`;
            });
          }
          ['Ca 2', 'Ca 3'].forEach(ca => {
            result += `${ca}:\n`;
            traList.forEach(loaiTra => {
              const records = caData[ca].filter(e => e.traSo.toLowerCase() === loaiTra);
              records.forEach(r => {
                const unit = r.traSo.toLowerCase() === 'lipton' ? 'g√≥i' : 'gram';
                result += `‚Ä¢ Tr√† ${r.traSo} n·∫•u th√™m: ${r.soLuong} ${unit} ‚Üí ${r.thanhPham} l√≠t (sau khi fill ra ca) (l√∫c ${r.thoiGian})\n`;
              });
            });
          });

          result += '\n________________________________________\n';
          result += '2) S·ªê L∆Ø·ª¢NG N·∫§U TR√ÇN CH√ÇU TR√Ä, TC ƒêEN\nCa 1:\n';
          // Ca 1 - tr√¢n ch√¢u
          tcList.forEach(tc => {
            const records = caData['Ca 1'].filter(e => e.traSo.toLowerCase() === tc);
            if (records.length > 0) {
              records.forEach(r => {
                result += `‚Ä¢ ${tc} n·∫•u ${r.soLuong} gram ‚Üí th√†nh ph·∫©m ${r.thanhPham} ph·∫ßn \n`;
              });
            }
          });

          // Ca 2, Ca 3 - tr√¢n ch√¢u
          ['Ca 2', 'Ca 3'].forEach(ca => {
            result += `${ca}:\n`;
            tcList.forEach(tc => {
              const records = caData[ca].filter(e => e.traSo.toLowerCase() === tc);
              if (records.length > 0) {
                records.forEach(r => {
                  result += `‚Ä¢ ${tc} n·∫•u th√™m: ${r.soLuong} gram (l√∫c ${r.thoiGian})\n`;
                });
              }
            });
          });

          document.getElementById('exportResult').textContent = result;
        })
        .catch(err => {
          console.error('L·ªói xu·∫•t d·ªØ li·ªáu:', err);
          document.getElementById('exportResult').textContent = 'ƒê√£ x·∫£y ra l·ªói khi xu·∫•t d·ªØ li·ªáu.';
        });
    }

    function copyExportResult() {
      const output = document.getElementById('exportResult').textContent;
      navigator.clipboard.writeText(output)
        .then(() => alert("ƒê√£ copy v√†o clipboard!"))
        .catch(err => alert("Kh√¥ng th·ªÉ copy: " + err));
    }

  style.
    .shift-wrapper {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }
    .shift-column {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .entry-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }
    .entry-row input,
    .entry-row select {
      flex: 1;
      padding: 4px;
    }
    .add-row {
      margin-top: 5px;
      margin-bottom: 10px;
    }
